<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NMEA Simulator Data</title>
    <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
    <link rel="stylesheet" href="/static/css/styles.css" />
    <style>
      .data-container { max-width: 1100px; margin: 20px auto; padding: 16px; }
      pre { background: var(--card-bg); padding: 12px; border-radius: 8px; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
      .muted { color: var(--muted); }
      .header-links { display: flex; gap: 12px; align-items: center; }
      .header-links a { color: var(--fg); text-decoration: none; border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; }
      .header-links a:hover { background: var(--hover-bg); }
      /* Console-style stream */
      .stream-box {
        background: #000 !important;
        color: #00ff6a;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        line-height: 1.35;
        border: 1px solid #0a0;
        border-radius: 8px;
        padding: 12px;
      }
      /* GNSS graphics */
      .gnss-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
      @media (min-width: 900px) { .gnss-grid { grid-template-columns: 1fr 1fr; } }
      .gnss-box { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
      .canvas-wrap { position: relative; width: 100%; aspect-ratio: 1 / 1; }
      .canvas-wrap.wide { aspect-ratio: 4 / 3; }
      .canvas-wrap > canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
      .legend { display:flex; gap: 10px; align-items:center; font-size: 0.85rem; color: var(--muted); margin-top: 6px; }
      .dot { display:inline-block; width: 10px; height: 10px; border-radius: 50%; border: 1px solid var(--border); }
      .dot.used { background: var(--primary); border-color: var(--primary); }
      .dot.free { background: transparent; }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1>Regatta NMEA 0183 Simulator</h1>
      <nav class="app-nav">
        <a href="/">CONTROL</a>
        <a href="/ais">AIS</a>
        <a href="/data">DATA</a>
        <button id="themeBtn" title="Toggle Day/Night">‚òÄÔ∏è</button>
      </nav>
    </header>

    <main class="data-container">
      <section class="card" style="margin-bottom: 16px;">
        <h2>Navigation</h2>
        <table>
          <tbody>
            <tr><th>Status</th><td id="status">Unknown</td></tr>
            <tr><th>Latitude</th><td id="lat">-</td></tr>
            <tr><th>Longitude</th><td id="lon">-</td></tr>
            <tr><th>SOG (kn)</th><td id="sog">-</td></tr>
            <tr><th>COG (¬∞T)</th><td id="cog">-</td></tr>
            <tr><th>Mag Var (¬∞)</th><td id="magvar">-</td></tr>
            <tr><th>Wind Enabled</th><td id="wind_enabled">-</td></tr>
            <tr><th>TWS (kn)</th><td id="tws">-</td></tr>
            <tr><th>TWD (¬∞T)</th><td id="twd">-</td></tr>
            <tr><th>Sim Time (UTC)</th><td id="sim_time">-</td></tr>
            <tr><th>TCP Port</th><td id="tcp_port">-</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card" style="margin-bottom: 16px;">
        <h2>TCP Clients</h2>
        <p class="muted">Connected TCP clients receiving the NMEA stream.</p>
        <table>
          <thead>
            <tr><th>Client</th><th>Connected</th></tr>
          </thead>
          <tbody id="tcpRows"></tbody>
        </table>
      </section>

      <section class="card" style="margin-bottom: 16px;">
        <h2>GNSS</h2>
        <table>
          <tbody>
            <tr><th>Sats in View</th><td id="siv">-</td></tr>
            <tr><th>Sats Used</th><td id="sused">-</td></tr>
            <tr><th>PDOP</th><td id="pdop">-</td></tr>
            <tr><th>HDOP</th><td id="hdop">-</td></tr>
            <tr><th>VDOP</th><td id="vdop">-</td></tr>
          </tbody>
        </table>
        <div class="gnss-grid" style="margin-top:12px;">
          <div class="gnss-box">
            <h3 style="margin: 0 0 8px 0;">Sky view</h3>
            <div class="canvas-wrap"><canvas id="skyPlot"></canvas></div>
            <div class="legend"><span class="dot used"></span> used in fix <span class="dot free" style="margin-left:10px;"></span> visible only</div>
          </div>
          <div class="gnss-box">
            <h3 style="margin: 0 0 8px 0;">Signal strength (SNR)</h3>
            <div class="canvas-wrap wide"><canvas id="snrChart"></canvas></div>
          </div>
        </div>
        <h3 style="margin-top: 12px;">Satellites (table)</h3>
        <table>
          <thead>
            <tr>
              <th>PRN</th>
              <th>Elev (¬∞)</th>
              <th>Az (¬∞)</th>
              <th>SNR (dB)</th>
              <th>Used</th>
            </tr>
          </thead>
          <tbody id="satRows"></tbody>
        </table>
      </section>

      <section class="card">
        <h2>Data Stream</h2>
        <p class="muted">Last 200 lines generated (NMEA and AIS).</p>
  <pre id="streamBox" class="stream-box" style="max-height: 320px; overflow: auto; white-space: pre-wrap;"></pre>
      </section>
    </main>

    <script>
      // Theme toggle for this page
      const html = document.documentElement;
      const themeBtn = document.getElementById('themeBtn');
      const savedTheme = localStorage.getItem('theme') || 'light';
      html.setAttribute('data-theme', savedTheme);
      function updateThemeIcon(){ const isDark = html.getAttribute('data-theme') === 'dark'; if(themeBtn) themeBtn.textContent = isDark ? 'üåô' : '‚òÄÔ∏è'; }
      updateThemeIcon();
      if (themeBtn) {
        themeBtn.addEventListener('click', () => {
          const isDark = html.getAttribute('data-theme') === 'dark';
          const t = isDark ? 'light' : 'dark';
          html.setAttribute('data-theme', t);
          localStorage.setItem('theme', t);
          updateThemeIcon();
        });
      }
      async function api(method, path){
        const res = await fetch(path, { method });
        const data = await res.json();
        if(!res.ok){ throw new Error(data.error || 'Request failed'); }
        return data;
      }

      function setText(id, val){ document.getElementById(id).textContent = val; }

      function renderData(d){
        setText('status', d.running ? 'Running' : 'Stopped');
        setText('lat', (d.lat ?? '-'));
        setText('lon', (d.lon ?? '-'));
        setText('sog', (d.sog ?? '-'));
        setText('cog', (d.cog ?? '-'));
        setText('magvar', (d.magvar ?? '-'));
        setText('wind_enabled', d.wind_enabled ? 'Yes' : 'No');
        setText('tws', d.wind_enabled ? (d.tws ?? '-') : '‚Äî');
        setText('twd', d.wind_enabled ? (d.twd ?? '-') : '‚Äî');
        setText('sim_time', d.sim_time || '‚Äî');
  setText('tcp_port', d.tcp_port ?? '‚Äî');

        const gnss = d.gnss || {};
        setText('siv', gnss.sats_in_view ?? '-');
        setText('sused', gnss.sats_used ?? '-');
        setText('pdop', gnss.pdop ?? '-');
        setText('hdop', gnss.hdop ?? '-');
        setText('vdop', gnss.vdop ?? '-');

        const rowsEl = document.getElementById('satRows');
        rowsEl.innerHTML = '';
        (gnss.satellites || []).forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.prn}</td><td>${s.elev}</td><td>${s.az}</td><td>${s.snr}</td><td>${s.used ? '‚úì' : ''}</td>`;
          rowsEl.appendChild(tr);
        });

        // Draw graphics
        lastGnss = gnss;
        drawSkyPlot();
        drawSnrBars();

        // TCP clients
        const tcpRows = document.getElementById('tcpRows');
        if (tcpRows){
          tcpRows.innerHTML = '';
          (d.tcp_clients || []).forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${c.address}</td><td>${c.connected_at || ''}</td>`;
            tcpRows.appendChild(tr);
          });
        }
      }

      async function tick(){
        try{
          const data = await api('GET', '/api/status');
          renderData(data);
        }catch(e){ /* ignore */ }
      }

      async function refreshStream(){
        try{
          const res = await fetch('/api/stream?limit=200');
          const data = await res.json();
          if(Array.isArray(data.lines)){
            const box = document.getElementById('streamBox');
            // Update content and auto-scroll to bottom
            box.textContent = data.lines.join('\n');
            box.scrollTop = box.scrollHeight;
          }
        }catch(e){ /* ignore */ }
      }

      tick();
      setInterval(tick, 2000);
      refreshStream();
      setInterval(refreshStream, 2000);

      // --- GNSS graphics (sky view + SNR bars) ---
      let lastGnss = null;
      function setupCanvas(canvas){
        if (!canvas) return { ctx: null, w:0, h:0, dpr: 1 };
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(100, Math.floor(rect.width));
        const h = Math.max(100, Math.floor(rect.height));
        if (canvas.width !== Math.floor(w * dpr) || canvas.height !== Math.floor(h * dpr)){
          canvas.width = Math.floor(w * dpr);
          canvas.height = Math.floor(h * dpr);
        }
        const ctx = canvas.getContext('2d');
        if (ctx){ ctx.setTransform(dpr, 0, 0, dpr, 0, 0); }
        return { ctx, w, h, dpr };
      }

      function drawSkyPlot(){
        const canvas = document.getElementById('skyPlot');
        const { ctx, w, h } = setupCanvas(canvas);
        if (!ctx) return;
        ctx.clearRect(0,0,w,h);
        const cx = w/2, cy = h/2;
        const R = Math.min(w,h)/2 - 10;
        // Colors
        const border = getComputedStyle(document.documentElement).getPropertyValue('--border') || '#e5e7eb';
        const fg = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#1f2937';
        const muted = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#6b7280';
        const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#2563eb';
        // Grid circles (30¬∞, 60¬∞, 90¬∞ horizon)
        ctx.strokeStyle = border; ctx.lineWidth = 1;
        [1, 2, 3].forEach(k => { ctx.beginPath(); ctx.arc(cx, cy, (R * k)/3, 0, Math.PI*2); ctx.stroke(); });
        // Crosshair (N/E/S/W)
        ctx.beginPath(); ctx.moveTo(cx, cy-R); ctx.lineTo(cx, cy+R); ctx.moveTo(cx-R, cy); ctx.lineTo(cx+R, cy); ctx.stroke();
        // Labels N/E/S/W
        ctx.fillStyle = muted; ctx.font = '12px system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('N', cx, cy - R + 8);
        ctx.fillText('E', cx + R - 8, cy);
        ctx.fillText('S', cx, cy + R - 8);
        ctx.fillText('W', cx - R + 8, cy);
        // Satellites
        const sats = (lastGnss && Array.isArray(lastGnss.satellites)) ? lastGnss.satellites : [];
        sats.forEach(s => {
          const elev = Number(s.elev) || 0; // 0..90
          const az = Number(s.az) || 0;     // deg, 0=N
          const snr = Number(s.snr) || 0;   // dB
          const used = !!s.used;
          // Polar to screen: radius smaller with higher elevation
          const r = (1 - Math.max(0, Math.min(90, elev))/90) * (R - 10);
          const rad = az * Math.PI / 180.0;
          const x = cx + r * Math.sin(rad);
          const y = cy - r * Math.cos(rad);
          const size = Math.max(3, Math.min(9, (snr - 15) * 0.2));
          ctx.beginPath();
          ctx.fillStyle = used ? primary : 'transparent';
          ctx.strokeStyle = used ? primary : fg;
          ctx.lineWidth = 1.2;
          ctx.arc(x, y, size, 0, Math.PI*2);
          if (used) ctx.fill();
          ctx.stroke();
          // PRN label
          ctx.fillStyle = fg; ctx.font = '11px system-ui'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
          ctx.fillText(String(s.prn), x, y + size + 2);
        });
      }

      function drawSnrBars(){
        const canvas = document.getElementById('snrChart');
        const { ctx, w, h } = setupCanvas(canvas);
        if (!ctx) return;
        ctx.clearRect(0,0,w,h);
        const fg = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#1f2937';
        const muted = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#6b7280';
        const border = getComputedStyle(document.documentElement).getPropertyValue('--border') || '#e5e7eb';
        const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#2563eb';
        const sats = (lastGnss && Array.isArray(lastGnss.satellites)) ? [...lastGnss.satellites] : [];
        // Sort by PRN for stable layout
        sats.sort((a,b) => (a.prn||0) - (b.prn||0));
        // Axes
        const pad = 28;
        const chartW = w - pad*2; const chartH = h - pad*2;
        ctx.strokeStyle = border; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.rect(pad, pad, chartW, chartH); ctx.stroke();
        // Grid lines for SNR 20, 30, 40, 50
        ctx.fillStyle = muted; ctx.font = '11px system-ui'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
        [20,30,40,50].forEach(snr => {
          const y = pad + chartH * (1 - (snr/60));
          ctx.strokeStyle = border; ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad+chartW, y); ctx.stroke();
          ctx.fillText(String(snr), pad - 4, y);
        });
        // Bars
        const n = Math.max(1, sats.length);
        const gap = 4; const barW = Math.max(6, (chartW - gap*(n+1)) / n);
        ctx.textAlign = 'center'; ctx.textBaseline = 'top';
        sats.forEach((s, i) => {
          const snr = Math.max(0, Math.min(60, Number(s.snr)||0));
          const used = !!s.used;
          const x = pad + gap + i*(barW + gap);
          const hpx = chartH * (snr/60);
          const y = pad + (chartH - hpx);
          ctx.fillStyle = used ? primary : fg;
          ctx.globalAlpha = used ? 0.95 : 0.35;
          ctx.fillRect(x, y, barW, hpx);
          ctx.globalAlpha = 1;
          // PRN label
          ctx.fillStyle = fg; ctx.font = '11px system-ui';
          ctx.fillText(String(s.prn), x + barW/2, pad + chartH + 4);
        });
      }

      // Redraw on resize
      window.addEventListener('resize', () => {
        drawSkyPlot();
        drawSnrBars();
      });
    </script>
  </body>
</html>
